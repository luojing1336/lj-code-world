# SQL学习

## 1. 快速上手SQL的常用语法

1. 通过表单查询逐步理解SQL语句

   学生表student结构如下图：

   ![img](https://pic4.zhimg.com/80/v2-7b240482346c2874c9d841d2dad49ac8_720w.jpg?source=1940ef5c)

   创建Student表：

   ```sql
   CREATE TABLE Student(
   	Sid int primary key auto_increment,
   	Sname varchar(20),
   	Sage datetime,
   	Ssex varchar(20)
   );
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('赵雷','1990-01-01 00:00:00','男');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('钱电','1990-12-21 00:00:00','男');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('孙风','1990-12-20 00:00:00','男');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('李云','1990-12-06 00:00:00','男');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('周梅','1991-12-01 00:00:00','女');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('吴兰','1992-01-01 00:00:00','女');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('郑竹','1989-01-01 00:00:00','女');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('张三','2017-12-20 00:00:00','女');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('张三','2017-12-20 00:00:00','女');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('李四','2017-12-25 00:00:00','女');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('李四','2012-06-06 00:00:00','女');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('赵六','2013-06-13 00:00:00','女');
   INSERT INTO Student(Sname,Sage,Ssex) VALUES('孙七','2014-06-01 00:00:00','女');
   DELETE FROM Student WHERE Sid = 8;
   ```

   先看一个查询例子：

   ```sql
   #查询表中所有学号小于8的男学生的学号和姓名
   select 
   		sid,sname #需要查询出来的字段
   from student	#从哪张表提取数据
   where ssex = '男' and sid < 8	#设置查询的条件
   ```

   暂时我们没有对字段做处理，如果你需要对选择出来的结果进行处理，需要使用函数和order by，再看一个例子：

   ```sql
   #查询每个男学生的学号、姓名和年龄，并按照学号降序排列
   select
   		sid,sname
   		,(curdate())-year(sage) as age #当前年份减去出生年份得到年龄
   from student
   where ssex='男'
   order by sid desc	#order by表示按照字段排序，desc表示降序
   
   ```

   其他常用的函数和where条件：

   ```sql
   #查询学号非空，姓“张”的学生，按照sid升序取前三条
   select
   		sid,sname
   from student
   where sname like '张%'	#通过like和通配符%进行模糊匹配
   and sid is not null		#学号非空
   ```

2. 多表查询

学生表student：

![img](https://pic4.zhimg.com/80/v2-7b240482346c2874c9d841d2dad49ac8_720w.jpg?source=1940ef5c)

成绩表sc：

![img](https://pic1.zhimg.com/80/v2-d681567ae859b71eaaab465f6fbfb5e8_720w.jpg?source=1940ef5c)

通过join连接两张表：

```sql
#查询赵雷每门课的成绩
select
		sname, cid, score
from student
inner ioin sc
on student.sid = sc.sid	#两张表的连接条件，满足条件的两行会并为一行
where sc.sname = '赵雷'
```

## 2. 数据库表结构

熟练使用SQL的前提一定是先了解你的数据库表，现在花点时间看看这四张表的字段信息(描述每个字段的意义)和数据样例(给出部分真实数据)，关于业务中用到的表结构可以找数据要。

学生表：

![img](https://pic1.zhimg.com/80/v2-acf99b66a71ad9700739fb964b75898d_720w.jpg?source=1940ef5c)

```sql
Student（SId，Sname，Sage，Ssex）
#SId 学生编号，Sname 学生姓名，Sage 出生年月，Ssex 学生性别
```

课程表：

![img](https://pic2.zhimg.com/80/v2-c36534e5f6e929a255ee192104237896_720w.jpg?source=1940ef5c)

```sql
Course（CId，Cname，TId）
#CId 课程编号，Cname 课程名称，TId 教师编号
```

教师表：

![img](https://pic2.zhimg.com/80/v2-07fe9c3b257c3e99d240012e7781c52e_720w.jpg?source=1940ef5c)

```sql
Teacher（TId，Tname）
#TId 教师编号，Tname 教师姓名
```

成绩表：

![img](https://pic4.zhimg.com/80/v2-0f6c0e5dfe4abcde878dcdfd8ff7d0d7_720w.jpg?source=1940ef5c)

```sql
SC（SId，CId，score）
#SId 学生编号，CId 课程编号，score 分数
```

## 3. SQL的执行顺序与语法顺序

SQL语句是有执行优先级的，必须理解SQL语句的执行顺序和语法顺序

SQL语法顺序：

```sql
SELECT <目标列名序列,函数>	#需要哪些列	
FROM <表名>				#来自哪些表
WHERE <分区条件与检索条件>  #根据什么条件
[GROUP BY <分组依据列>]	  #需要聚合的列
[ORDER BY <排序依据列>]	  #按照什么排序
[LIMIT N <只看结果的前N条>] #看样例
#注：中括号内的东西非必填项
```

SQL执行顺序：

```sql
FROM <表名>				#第一步先选择表
WHERE <分区条件与检索条件>  #对表中数据增加限制条件
[GROUP BY <分组依据列>]	  #分组输出聚合结果
SELECT <目标列名序列,函数>	#选择需要呈现的手段
[ORDER BY <排序依据列>]	  #对结果按照字段排序
[LIMIT N <只看结果的前N条>] #限制结果条数
#注：中括号内的东西非必填项
```

通过一个实例复习SQL的执行顺序：

```sql
#在限定学生表学号小于等于6的一批学生中，查询每门课的最高成绩（最高成绩低于70分的课程不显示），然后根据课程最高成绩降序排列取前两条记录，用于查询的SQL如下：
SELECT
		cid	#课程号
		,max(score) as max_score	#最高分
from sc	#成绩表
where sid <= 6	#限制只查询学号小于等于6的学生成绩
group by cid	#按照课程分组查看每门课程的聚合信息
having max(score) >= 70	#对分组后的结果筛选，选取最高成绩>=70的课程
order by max(score)
limit 2;	#只展示前两条数据
```

SQL语句的可以分为：

1. 条件子句：where子句

   条件子句——为被查询的表增加限制条件

   ```sql
   where sid <= 6	#限制只查询学号小于等于6的学生成绩
   ```

2. 分组查询：group by子句和having子句

   分组查询——实现聚合(group by+聚合函数)限制聚合条件(having)

   ```sql
   group by cid	#按照课程分组查看每门课程的聚合信息
   max(score)	#搭配group by子句使用的聚合函数，表示每门课的最高成绩
   having max(score) >= 70	#对分组后的结果筛选，选取最高成绩>=70的课程
   ```

3. 字段选择——select

   在group by分组后紧跟着我们会选择需要呈现的字段，为了方便讲解，其实分组查询中呈现的图片已经是select的结果了

4. 结果呈现：order by子句和limit

   结果呈现——排序(order by)和限制条数(limit)

   order by和limit都是为了修改最终呈现结果，order by首先执行，按照某个字段进行排序(desc关键字表示降序)，这部分和excel的排序很相似，最后我们使用limit来修改结果展示的条数

5. 连接查询：left/right/inner join

## 4. 介绍各个子句的细节

### 4.1 条件子句(where)

1. 比较运算符(适用于区间)

   比较运算符包括：=，>=，<=，!=，>，<。

   ```sql
   where sage < 30	#查询年龄小于30的学生
   ```

2. 确定范围(适用于连续范围)

   between…and…为取值限定了一个范围

   ```sql
   where sage between 10 and 20	#查询年龄>=10和<=20的学生
   ```

3. 确定集合(适用于离散的少数值)

   ```sql
   where sage in (10,20,30)	#插入年龄为10，20，30的学生
   where sage not in (10,20,30)	#in可以和not一起使用，表示不在这个区间的值
   ```

4. 字符匹配(模糊查询)

   ```sql
   where sname like "%王%	#查询姓名sname不为空的学生#通过like关键字和正则表达式匹配
   ```

5. 判断是否为空值

   ```sql
   where sname is not null	#查询姓名sname不为空的学生#通过is null关键字判断值是否为空
   ```

6. 多个查询条件

   ```sql
   where sage < 20 and ssex ='男'	#查询年龄sage小于20且性别ssex为男的学生
   #用and和or来执行多个条件
   ```

### 4.2 分组查询(group by&聚合函数&having子句)

1. group by

   group by不仅可以对一个字段进行分组，还能对多个字段进行分组，这和excel中的透视表一致

2. 聚合函数

   * count(id):统计表中id个数
   * count(distinct id):统计表中id个数（去重）
   * max(id):统计id最大值
   * min(id):统计id最小值
   * sum(id):统计id之和
   * avg(id):统计id平均值

3. having子句

   和where子句一致，只需注意是对聚合后的结果作限制

### 4.3 字段选择(select)

​	select比较灵活，我们不单单能选择原始数据表的字段，还能使用函数对字段进行计算

```sql
select
		sid,sname,year(curdate()-year(sage)) as age
from student;	#查询各学生的年龄(通过公式计算年龄)
```

### 4.4 结果呈现(order by)

1. 和excel一样，可以用多个字段排序
2. 关键字desc表示降序排列

```sql
select
		sid, sage	#查询学生id和年龄
from student
order by sid desc, sage	#并按照学号sid降序，再按照年龄sage升序排列
```

## 5. 表的连接和其他常用关键字

### 5.1 表的连接

通过等值连接join实现两个及两个以上表的查询需求，sql表连接包括内连接、外连接和交叉连接

有一个例子如下：

A表及记录学生学号sid和对应的姓名name，B表记录学生学号sid和对应的分数score

![preview](https://pic1.zhimg.com/v2-1973aa784c2676fc149b0151603a5683_r.jpg?source=1940ef5c)

1. 内连接：通过某个字段进行等值匹配从而将两个表联合起来，inner join

   比如：查询两个表中同一个学号对应的姓名和成绩

   ![preview](https://pic1.zhimg.com/v2-19d57f993c2d0889acc675deeb4555f5_r.jpg?source=1940ef5c)

2. 左连接和右连接

   左连接指的是将左表作为基准表，保留表中的所有行，将右表根据某个字段进行等值匹配，如果找不到右表中匹配的行则显示为NULL

   比如：A左连接B表

   ![img](https://pic1.zhimg.com/80/v2-ad0d387e97b84041c19412423d88d726_720w.jpg?source=1940ef5c)

3. 交叉连接

   没有连接条件的表连接将产生笛卡尔积，即连接结果行数等于A表行数乘以B表行数，可以理解为两个表的记录两两配对产生的结果

   比如：A交叉连接B

   ![img](https://pic3.zhimg.com/80/v2-b34af2c303ef999a0fed7850685de607_720w.jpg?source=1940ef5c)

### 5.2 其他常用关键字

1. case when：根据字段的不同值进行不同操作

   ```sql
   # sex字段为1和2，现在要转化为更为直观的文字形式
   case sex
   	when '1' then '男'
   	when '2' then '女'
   else '未知'
   end as sex
   ```

2. count+distinct+if：实现统计

   ```sql
   #统计成绩单中及格同学的人数(单个学号可能出现多条记录)
   count(distinct(if(score >= 60,sid,null)))
   ```

3. sum+if：实现分组统计(这里sum可以替换为其他聚合函数)

   ```sql
   #获取男性学生的总成绩
   sum(if(sex='男',score,0))
   ```